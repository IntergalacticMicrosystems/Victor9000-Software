.387
		PUBLIC	dos_install_crit_handler_
		PUBLIC	dos_restore_crit_handler_
		PUBLIC	dos_exit_
		PUBLIC	dos_get_drive_
		PUBLIC	dos_set_drive_
		PUBLIC	dos_is_drive_valid_
		PUBLIC	dos_is_drive_ready_
		PUBLIC	dos_get_valid_drives_
		PUBLIC	dos_get_dta_
		PUBLIC	dos_set_dta_
		PUBLIC	dos_find_first_
		PUBLIC	dos_find_next_
		PUBLIC	dos_get_curdir_
		PUBLIC	dos_chdir_
		PUBLIC	dos_mkdir_
		PUBLIC	dos_rmdir_
		PUBLIC	dos_open_
		PUBLIC	dos_create_
		PUBLIC	dos_close_
		PUBLIC	dos_read_
		PUBLIC	dos_cursor_off_
		PUBLIC	dos_cursor_on_
		PUBLIC	dos_write_
		PUBLIC	dos_file_size_
		PUBLIC	dos_delete_
		PUBLIC	dos_rename_
		PUBLIC	dos_exists_
		PUBLIC	dos_get_attr_
		PUBLIC	dos_set_attr_
		PUBLIC	dos_get_free_space_
		EXTRN	_dos_getvect_:BYTE
		EXTRN	_dos_setvect_:BYTE
		EXTRN	int86_:BYTE
		EXTRN	segread_:BYTE
		EXTRN	int86x_:BYTE
		EXTRN	__U4M:BYTE
		EXTRN	_small_code_:BYTE
DGROUP		GROUP	CONST,CONST2,_DATA
_TEXT		SEGMENT	BYTE PUBLIC USE16 'CODE'
		ASSUME CS:_TEXT, DS:DGROUP, SS:DGROUP
crit_error_handler_:
	push		ax
	push		cx
	push		dx
	push		bx
	push		sp
	push		bp
	push		si
	push		di
	push		ds
	push		es
	push		ax
	push		ax
	mov		bp,sp
	cld
	mov		word ptr 10H[bp],3
	pop		ax
	pop		ax
	pop		es
	pop		ds
	pop		di
	pop		si
	pop		bp
	pop		bx
	pop		bx
	pop		dx
	pop		cx
	pop		ax
	iret
dos_install_crit_handler_:
	push		bx
	push		cx
	push		dx
	cmp		byte ptr ss:_crit_handler_installed,0
	jne		L$1
	mov		ax,24H
	call		near ptr _dos_getvect_
	mov		word ptr ss:_old_int24,ax
	mov		word ptr ss:_old_int24+2,dx
	mov		bx,offset crit_error_handler_
	mov		cx,seg crit_error_handler_
	mov		ax,24H
	call		near ptr _dos_setvect_
	mov		byte ptr ss:_crit_handler_installed,1
L$1:
	jmp		near ptr L$8
dos_restore_crit_handler_:
	push		bx
	push		cx
	cmp		byte ptr ss:_crit_handler_installed,0
	je		L$3
	mov		bx,word ptr ss:_old_int24
	mov		cx,word ptr ss:_old_int24+2
	test		cx,cx
	jne		L$2
	test		bx,bx
	je		L$3
L$2:
	mov		ax,24H
	call		near ptr _dos_setvect_
	xor		ax,ax
	mov		word ptr ss:_old_int24,ax
	mov		word ptr ss:_old_int24+2,ax
	mov		byte ptr ss:_crit_handler_installed,0
L$3:
	pop		cx
	pop		bx
	ret
dos_exit_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,0eH
	mov		byte ptr -0dH[bp],4cH
	mov		byte ptr -0eH[bp],al
L$4:
	mov		cx,ss
	lea		bx,-0eH[bp]
	push		ss
	push		bx
	mov		ax,21H
	call		near ptr int86_
	jmp		near ptr L$24
dos_get_drive_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,0eH
	mov		byte ptr -0dH[bp],19H
	mov		cx,ss
	lea		bx,-0eH[bp]
	push		ss
	push		bx
	mov		ax,21H
	call		near ptr int86_
	mov		al,byte ptr -0eH[bp]
	jmp		near ptr L$24
dos_set_drive_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,0eH
	mov		byte ptr -0dH[bp],0eH
	mov		byte ptr -8[bp],al
	jmp		L$4
dos_is_drive_valid_:
	push		bx
	push		cx
	push		dx
	push		bp
	mov		bp,sp
	sub		sp,10H
	mov		dl,al
	call		near ptr dos_install_crit_handler_
	call		near ptr dos_get_drive_
	mov		dh,al
	mov		byte ptr -0fH[bp],0eH
	mov		byte ptr -0aH[bp],dl
	lea		bx,-10H[bp]
	push		ss
	push		bx
	mov		cx,ss
	mov		ax,21H
	call		near ptr int86_
	call		near ptr dos_get_drive_
	mov		byte ptr -2[bp],al
	mov		byte ptr -0fH[bp],0eH
	mov		byte ptr -0aH[bp],dh
	lea		bx,-10H[bp]
	push		ss
	push		bx
	mov		cx,ss
	mov		ax,21H
	call		near ptr int86_
	call		near ptr dos_restore_crit_handler_
	cmp		dl,byte ptr -2[bp]
	jne		L$6
L$5:
	mov		ax,1
	jmp		L$7
L$6:
	xor		ax,ax
L$7:
	mov		sp,bp
	pop		bp
L$8:
	pop		dx
	pop		cx
	pop		bx
	ret
dos_is_drive_ready_:
	push		bx
	push		cx
	push		dx
	push		bp
	mov		bp,sp
	sub		sp,5cH
	mov		dl,al
	call		near ptr dos_install_crit_handler_
	mov		word ptr -18H[bp],4409H
	inc		dl
	mov		byte ptr -2[bp],dl
	mov		byte ptr -16H[bp],dl
	lea		dx,-18H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-18H[bp]
	mov		ax,21H
	call		near ptr int86_
	cmp		word ptr -0cH[bp],0
	je		L$9
	call		near ptr dos_restore_crit_handler_
	xor		al,al
	jmp		L$7
L$9:
	mov		dx,ss
	lea		ax,-0aH[bp]
	call		near ptr segread_
	mov		byte ptr -17H[bp],47H
	mov		al,byte ptr -2[bp]
	mov		byte ptr -12H[bp],al
	lea		ax,-5cH[bp]
	mov		word ptr -10H[bp],ax
	mov		word ptr -4[bp],ss
	lea		dx,-0aH[bp]
	push		ss
	push		dx
	lea		dx,-18H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-18H[bp]
	mov		ax,21H
	call		near ptr int86x_
	call		near ptr dos_restore_crit_handler_
	cmp		word ptr -0cH[bp],0
	je		L$5
	jmp		L$6
dos_get_valid_drives_:
	push		bx
	push		cx
	push		si
	push		di
	xor		si,si
	xor		di,di
	xor		bl,bl
	jmp		L$11
L$10:
	inc		bl
	cmp		bl,1aH
	jae		L$14
L$11:
	mov		al,bl
	xor		ah,ah
	call		near ptr dos_is_drive_valid_
	test		al,al
	je		L$10
	mov		cl,bl
	xor		ch,ch
	mov		ax,1
	xor		dx,dx
	jcxz		L$13
L$12:
	shl		ax,1
	rcl		dx,1
	loop		L$12
L$13:
	or		si,ax
	or		di,dx
	jmp		L$10
L$14:
	mov		ax,si
	mov		dx,di
L$15:
	pop		di
L$16:
	pop		si
	pop		cx
	pop		bx
	ret
dos_get_dta_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		byte ptr -15H[bp],2fH
	lea		cx,-8[bp]
	push		ss
	push		cx
	lea		cx,-16H[bp]
	push		ss
	push		cx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	mov		ax,word ptr -14H[bp]
	mov		dx,word ptr -8[bp]
	jmp		near ptr L$24
dos_set_dta_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		cx,ax
	mov		bx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],1aH
	mov		word ptr -10H[bp],cx
	mov		word ptr -2[bp],bx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	jmp		near ptr L$24
dos_find_first_:
	push		cx
	push		si
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		si,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],4eH
L$17:
	mov		al,bl
	xor		ah,ah
	mov		word ptr -12H[bp],ax
	mov		word ptr -10H[bp],si
	mov		word ptr -2[bp],cx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	mov		ax,word ptr -0aH[bp]
	test		ax,ax
	je		L$19
L$18:
	mov		ax,0ffffH
L$19:
	mov		sp,bp
	pop		bp
	pop		si
	pop		cx
	ret
dos_find_next_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,0eH
	mov		byte ptr -0dH[bp],4fH
L$20:
	lea		bx,-0eH[bp]
	push		ss
	push		bx
	mov		cx,ss
	mov		ax,21H
	call		near ptr int86_
	mov		ax,word ptr -2[bp]
	jmp		near ptr L$23
dos_get_curdir_:
	push		dx
	push		si
	push		di
	push		bp
	mov		bp,sp
	sub		sp,18H
	mov		byte ptr -2[bp],al
	mov		si,bx
	mov		di,cx
	mov		dx,ss
	lea		ax,-0aH[bp]
	call		near ptr segread_
	mov		byte ptr -17H[bp],47H
	mov		al,byte ptr -2[bp]
	mov		byte ptr -12H[bp],al
	mov		word ptr -10H[bp],bx
	mov		word ptr -4[bp],cx
	lea		dx,-0aH[bp]
	push		ss
	push		dx
	lea		dx,-18H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-18H[bp]
	mov		ax,21H
	call		near ptr int86x_
	mov		ax,word ptr -0cH[bp]
	test		ax,ax
	je		L$21
	mov		ds,di
	mov		byte ptr [si],0
	mov		ax,0ffffH
L$21:
	mov		sp,bp
	pop		bp
	pop		di
	pop		si
	pop		dx
	ret
dos_chdir_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		bx,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],3bH
L$22:
	mov		word ptr -10H[bp],bx
	mov		word ptr -2[bp],cx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	mov		ax,word ptr -0aH[bp]
L$23:
	test		ax,ax
	je		L$24
	mov		ax,0ffffH
L$24:
	mov		sp,bp
	pop		bp
	pop		cx
	pop		bx
	ret
dos_mkdir_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		bx,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],39H
	jmp		L$22
dos_rmdir_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		bx,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],3aH
	jmp		L$22
dos_open_:
	push		cx
	push		si
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		si,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],3dH
	mov		byte ptr -16H[bp],bl
	mov		word ptr -10H[bp],si
	mov		word ptr -2[bp],cx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	cmp		word ptr -0aH[bp],0
	je		L$25
	mov		ax,0ffffH
	jmp		near ptr L$19
L$25:
	mov		ax,word ptr -16H[bp]
	jmp		near ptr L$19
dos_create_:
	push		cx
	push		si
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		si,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],3cH
	mov		al,bl
	xor		ah,ah
	mov		word ptr -12H[bp],ax
	mov		word ptr -10H[bp],si
	mov		word ptr -2[bp],cx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	cmp		word ptr -0aH[bp],0
	je		L$25
	jmp		near ptr L$18
dos_close_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,0eH
	mov		byte ptr -0dH[bp],3eH
	mov		word ptr -0cH[bp],ax
	jmp		near ptr L$20
dos_read_:
	push		si
	push		di
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		si,ax
	mov		di,cx
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],3fH
L$26:
	mov		word ptr -14H[bp],si
	mov		word ptr -12H[bp],cx
	mov		word ptr -10H[bp],bx
	mov		word ptr -2[bp],di
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	cmp		word ptr -0aH[bp],0
	je		L$29
L$27:
	mov		ax,0ffffH
L$28:
	mov		sp,bp
	pop		bp
	pop		di
	pop		si
dos_cursor_off_:
dos_cursor_on_:
	ret
L$29:
	mov		ax,word ptr -16H[bp]
	jmp		L$28
dos_write_:
	push		si
	push		di
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		si,ax
	mov		di,cx
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],40H
	jmp		L$26
dos_file_size_:
	push		bx
	push		cx
	push		si
	push		di
	push		bp
	mov		bp,sp
	sub		sp,12H
	mov		dx,ax
	mov		word ptr -12H[bp],4201H
	mov		word ptr -10H[bp],ax
	xor		ax,ax
	mov		word ptr -0eH[bp],ax
	mov		word ptr -0cH[bp],ax
	lea		bx,-12H[bp]
	push		ss
	push		bx
	mov		cx,ss
	mov		ax,21H
	call		near ptr int86_
	cmp		word ptr -6[bp],0
	je		L$31
L$30:
	xor		ax,ax
	xor		dx,dx
	jmp		L$32
L$31:
	mov		di,word ptr -12H[bp]
	mov		ax,word ptr -0cH[bp]
	mov		word ptr -2[bp],ax
	mov		word ptr -12H[bp],4202H
	mov		word ptr -10H[bp],dx
	xor		ax,ax
	mov		word ptr -0eH[bp],ax
	mov		word ptr -0cH[bp],ax
	lea		bx,-12H[bp]
	push		ss
	push		bx
	mov		cx,ss
	mov		ax,21H
	call		near ptr int86_
	cmp		word ptr -6[bp],0
	jne		L$30
	mov		ax,word ptr -12H[bp]
	mov		word ptr -4[bp],ax
	mov		si,word ptr -0cH[bp]
	mov		word ptr -12H[bp],4200H
	mov		word ptr -10H[bp],dx
	mov		ax,word ptr -2[bp]
	mov		word ptr -0eH[bp],ax
	mov		word ptr -0cH[bp],di
	lea		dx,-12H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-12H[bp]
	mov		ax,21H
	call		near ptr int86_
	mov		ax,word ptr -4[bp]
	mov		dx,si
L$32:
	mov		sp,bp
	pop		bp
	jmp		near ptr L$15
dos_delete_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		bx,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],41H
	jmp		near ptr L$22
dos_rename_:
	push		si
	push		di
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		di,ax
	mov		si,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		byte ptr -15H[bp],56H
	mov		word ptr -10H[bp],di
	mov		word ptr -2[bp],si
	mov		word ptr -0cH[bp],bx
	mov		word ptr -8[bp],cx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	mov		ax,word ptr -0aH[bp]
	test		ax,ax
	jne		L$33
	jmp		near ptr L$28
L$33:
	jmp		near ptr L$27
dos_exists_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		cx,ax
	mov		bx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		word ptr -16H[bp],4300H
	mov		word ptr -10H[bp],cx
	mov		word ptr -2[bp],bx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	cmp		word ptr -0aH[bp],0
	je		L$34
	xor		ax,ax
	jmp		near ptr L$24
L$34:
	mov		ax,1
	jmp		near ptr L$24
dos_get_attr_:
	push		bx
	push		cx
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		bx,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		word ptr -16H[bp],4300H
	mov		word ptr -10H[bp],bx
	mov		word ptr -2[bp],cx
	lea		dx,-8[bp]
	push		ss
	push		dx
	lea		dx,-16H[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-16H[bp]
	mov		ax,21H
	call		near ptr int86x_
	cmp		word ptr -0aH[bp],0
	je		L$35
	mov		ax,0ffffH
	jmp		near ptr L$24
L$35:
	mov		ax,word ptr -12H[bp]
	jmp		near ptr L$24
dos_set_attr_:
	push		cx
	push		si
	push		bp
	mov		bp,sp
	sub		sp,16H
	mov		si,ax
	mov		cx,dx
	mov		dx,ss
	lea		ax,-8[bp]
	call		near ptr segread_
	mov		word ptr -16H[bp],4301H
	jmp		near ptr L$17
dos_get_free_space_:
	push		bx
	push		cx
	push		si
	push		bp
	mov		bp,sp
	sub		sp,0eH
	mov		byte ptr -0dH[bp],36H
	inc		al
	mov		byte ptr -8[bp],al
	lea		dx,-0eH[bp]
	push		ss
	push		dx
	mov		cx,ss
	lea		bx,-0eH[bp]
	mov		ax,21H
	call		near ptr int86_
	cmp		word ptr -0eH[bp],0ffffH
	jne		L$36
	xor		ax,ax
	xor		dx,dx
	jmp		L$38
L$36:
	mov		si,word ptr -0aH[bp]
	mov		ax,word ptr -0cH[bp]
	xor		dx,dx
	mov		bx,word ptr -0eH[bp]
	xor		cx,cx
	call		near ptr __U4M
	mov		bx,si
	xor		cx,cx
	call		near ptr __U4M
	mov		cx,0aH
L$37:
	shr		dx,1
	rcr		ax,1
	loop		L$37
L$38:
	mov		sp,bp
	pop		bp
	jmp		near ptr L$16
_TEXT		ENDS
CONST		SEGMENT	WORD PUBLIC USE16 'DATA'
CONST		ENDS
CONST2		SEGMENT	WORD PUBLIC USE16 'DATA'
CONST2		ENDS
_DATA		SEGMENT	WORD PUBLIC USE16 'DATA'
_old_int24:
    DB	0, 0, 0, 0
_crit_handler_installed:
    DB	0

_DATA		ENDS
		END
